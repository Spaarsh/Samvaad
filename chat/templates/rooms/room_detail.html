{% extends "base_generic.html" %}

{% block content %}
    <h2>{{ room.name }}</h2>
    <p>User ID: {{ user.id }}</p>
    <!-- Display all previous messages -->
    <div id="chat-log">
        {% for message in messages %}
            {% if message.user == user %}
                <div style="color: blue;">
                    <strong>{{ message.user.username }}:</strong> {{ message.content }}
                </div>
            {% else %}
                <div style="color: black;">
                    <strong>{{ message.user.username }}:</strong> {{ message.content }}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Form to post a new message -->
    <form id="post-message">
        <input type="text" id="message-input">
        <input type="hidden" id="user-id" value="{{ user.id }}">
        <input type="hidden" id="room-id" value="{{ room.id }}">
        <button type="submit">Send</button>
    </form>

    <!-- WebSocket scripts -->
    <script>
        // Connect to the WebSocket
        var socket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/room/{{ room.name }}/');

        socket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var message = data['message'];

            // Add the message to the chat log
            document.querySelector('#chat-log').innerHTML += (
                '<div>' +
                '<strong>' + data['username'] + ':</strong> ' +
                message +
                '</div>');
        };

        socket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#post-message').onsubmit = function(e) {
            e.preventDefault();

            // Retrieve the input field's value
            var messageInputDom = document.querySelector('#message-input');
            var message = messageInputDom.value;

            // Retrieve the user ID and room ID
            var userId = document.querySelector('#user-id').value;
            var roomId = document.querySelector('#room-id').value;

            // Print the user ID and room ID to the console
            console.log('User ID:', userId);
            console.log('Room ID:', roomId);

            // Get the current timestamp
            var timestamp = new Date().toISOString();

            // Send the message to the server
            socket.send(JSON.stringify({
                'message': message,
                'user_id': userId,
                'room_id': roomId,
                'timestamp': timestamp
            }));

            // Clear the input field and focus it
            messageInputDom.value = '';
            messageInputDom.focus();
        };
    </script>
{% endblock %}