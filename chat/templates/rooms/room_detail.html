{% extends "base_generic.html" %}
{% load static %}

{% block content %}
    <style>
        body {
            background-color: white;
            padding-left: 50px; /* Add left padding equal to the width of the left margin */
        }
        #header {
            background-color: skyblue;
            text-align: center;
            padding: 20px;
        }
        #header h2 {
            color: black;
        }
        #logo {
            background-color: yellow;
            position: absolute;
            top: 0;
            left: 0;
            width: 50px;
            height: 50px;
            border-radius: 50%; /* Make the logo circular */
        }
        .message {
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            width: 50%; /* Make the message boxes half the width of the screen */
        }
        .message.other {
            background-color: blue;
            color: white;
            text-align: left;
        }
        .message.self {
            background-color: lightgreen;
            text-align: right; /* Align the messages from the current user to the right */
        }
        .timestamp {
            font-size: 0.8em;
        }
        #post-message input[type="text"] {
            width: 80%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            margin: 10px 0;
            display: inline-block;
        }
        /*#post-message button {
            display: none;
        }*/
        /* Add a left margin with sky blue color */
        .left-margin {
            position: fixed;
            left: 0;
            top: 0;
            width: 50px;
            height: 100%;
            background-color: skyblue;
        }

        #logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover; /* This will ensure that the image covers the entire area of the div without stretching */
    }
    </style>

    <div class="left-margin"></div>

    <div id="logo">
        <img src="{% static 'room_logos/'|add:room.name|stringformat:"s"|add:'.jpg' %}" alt="Logo">
    </div>

    <div id="header">
        <h2>{{ room.name }}</h2>
    </div>

    <div id="chat-log">
        {% for message in messages %}
            <div class="message {% if message.user == user %}self{% else %}other{% endif %}">
                <strong>{{ message.user.username }}:</strong> {{ message.content }}
                <div class="timestamp">{{ message.timestamp }}</div>
            </div>
        {% endfor %}
    </div>

    <form id="post-message">
        <input type="text" id="message-input" placeholder="Enter your awesome message here">
        <input type="hidden" id="user-id" value="{{ user.id }}">
        <input type="hidden" id="room-id" value="{{ room.id }}">
        <button type="submit">Send</button>
    </form>

    <!-- WebSocket scripts -->
    <script>
        // Connect to the WebSocket
        var socket = new WebSocket(
    'ws://' + window.location.host +
    '/ws/room/{{ room.name }}/'
);

// Connect to the WebSocket
var socket = new WebSocket('ws://' + window.location.host + '/ws/room/{{ room.name }}/');
var roomId = document.querySelector('#room-id').value;
var chatLog = document.querySelector('#chat-log'); // Define chatLog here

socket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    console.log(data);

    var message = data['message'];
    var messageColorClass;

    var userId = parseInt(document.querySelector('#user-id').value); // Parse userId as integer

    console.log('userId:', userId);
    console.log('data[\'user_id\']:', data['userId']);

    if (data['userId'] === userId) {
        messageColorClass = 'self';
    } else {
        messageColorClass = 'other';
    }

    var timestamp = new Date(data['timestamp']);
    var formattedTimestamp = timestamp.toLocaleString('en-US', {
        hour: 'numeric',
        minute: 'numeric',
        hour12: true,
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    // Create a new message element
    var messageElem = document.createElement('div');
    messageElem.classList.add('message', messageColorClass); // Add message and color class

    // Create strong element for username
    var usernameElem = document.createElement('strong');
    usernameElem.textContent = data['username'] + ': ';

    // Create text node for message content
    var messageContent = document.createTextNode(message);

    // Create div for timestamp
    var timestampElem = document.createElement('div');
    timestampElem.classList.add('timestamp');
    timestampElem.textContent = formattedTimestamp;

    // Append username, message content, and timestamp to message element
    messageElem.appendChild(usernameElem);
    messageElem.appendChild(messageContent);
    messageElem.appendChild(timestampElem);

    // Add the message to the chat log
    chatLog.appendChild(messageElem);

    // Scroll to the bottom of the chat log
    chatLog.scrollTop = chatLog.scrollHeight;
};

// Other WebSocket event handlers...


socket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};

document.querySelector('#post-message').onsubmit = function(e) {
    e.preventDefault();

    // Retrieve the input field's value
    var messageInputDom = document.querySelector('#message-input');
    var message = messageInputDom.value;

    // Retrieve the user ID and room ID
    var userId = document.querySelector('#user-id').value;
    var roomId = document.querySelector('#room-id').value;

    // Get the current timestamp
    var timestamp = new Date().toISOString();

    // Send the message to the server
    socket.send(JSON.stringify({
        'message': message,
        'user_id': userId,
        'room_id': roomId,
        'timestamp': timestamp
    }));

    // Clear the input field and focus it
    messageInputDom.value = '';
    messageInputDom.focus();
};


    </script>
{% endblock %}